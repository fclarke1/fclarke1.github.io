<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-06-08">
<meta name="description" content="Building an 8-Bit CPU using low-level TTL chips">

<title>Fred Clarke - Building an 8-Bit Computer from Scratch</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Fred Clarke</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../exploration/index.html"> 
<span class="menu-text">Exploration</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/fclarke1"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/clarkefred/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#how-does-a-cpu-work" id="toc-how-does-a-cpu-work" class="nav-link active" data-scroll-target="#how-does-a-cpu-work">How does a CPU work?</a></li>
  <li><a href="#extensions-in-my-build" id="toc-extensions-in-my-build" class="nav-link" data-scroll-target="#extensions-in-my-build">Extensions in my build</a></li>
  <li><a href="#how-do-you-program-the-cpu" id="toc-how-do-you-program-the-cpu" class="nav-link" data-scroll-target="#how-do-you-program-the-cpu">How do you program the CPU</a></li>
  <li><a href="#an-example-program" id="toc-an-example-program" class="nav-link" data-scroll-target="#an-example-program">An example program</a>
  <ul class="collapse">
  <li><a href="#add-x-y" id="toc-add-x-y" class="nav-link" data-scroll-target="#add-x-y">Add X + Y</a></li>
  <li><a href="#fibonacci-sequence" id="toc-fibonacci-sequence" class="nav-link" data-scroll-target="#fibonacci-sequence">Fibonacci Sequence</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Building an 8-Bit Computer from Scratch</h1>
  <div class="quarto-categories">
    <div class="quarto-category">electronics</div>
  </div>
  </div>

<div>
  <div class="description">
    Building an 8-Bit CPU using low-level TTL chips
  </div>
</div>


<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">2024-06-08</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>Having done a fair bit of programming I eventually asked myself <em>how does a computer actually work and run a program?</em> Initially I thought it would be a quick google, watch a few videos and then that was that. But after at least 100 hours of work, I can confidently say I’m satisfied with the answer I got.</p>
<p>What it comes down to is the CPU, this is the brain of the computer. All programming code, no matter what language, is eventually compiled into machine language the CPU can run a program with. So of course I had to build my own CPU using only low-level TTL chips.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="8bit_computer/low_overview.jpg" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption>CPU overview</figcaption>
</figure>
</div>
<p>After a bit of a convoluted journey, and an initial failed attempt, I finally have a working 8-bit programmable computer that runs on a custom machine code. I have to say, there were two incredible resources for this:</p>
<ol type="1">
<li><a href="https://www.youtube.com/watch?v=HyznrdDSSGM&amp;list=PLowKtXNTBypGqImE405J2565dvjafglHU&amp;ab_channel=BenEater">Ben Eater’s 8-bit computer</a> YouTube series. An incredible series where Ben starts from the absolute fundementals, and explains how every chip works from the level of transistors. I highly recommend his series, even just to watch and not follow the build.</li>
<li><a href="https://www.reddit.com/r/beneater/">Reddit</a>. Even though Ben Eater’s series is fantastic, no one understands how his computer actually works because there are so many shortcuts he takes. This is where I failed first time, I followed blindly and came to many power issues. Luckily a few years later I found the subreddit on Ben Eater’s 8-bit computer and it had so much information on how to fix the issues I previously had. This gave me the confidence to jump into the build again.</li>
</ol>
<section id="how-does-a-cpu-work" class="level1">
<h1>How does a CPU work?</h1>
<p>If you want all the detail Ben Eater’s series is definietly the place to go. But I’ll give a quick overview of each modules in the CPU:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="8bit_computer/SAP_architecture.jpg" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption>SAP architecture (Simple-As-Possible)</figcaption>
</figure>
</div>
<p>I was building the most simple architecture for a programmable CPU, but it still contains all major components. It’s a very modular design, so we can think of the main modules as:</p>
<ul>
<li>Clock: synchronises all other modules and data transfer. My CPU is upto 1MHz</li>
<li>ALU: where the calculations happen. My CPU can only add and subtract</li>
<li>Register A/B: Used to store actively used data. Each register can hold one 8-bit number</li>
<li>RAM: this is where your program is stored, can hold only 16x 8-bit numbers</li>
<li>Memory Register: used to select a RAM data line, eg. get the 8-bit number stored at index 4 (out of 16)</li>
<li>Instruction Register: translates the machine code into a control word which controls all other modules</li>
<li>Program Counter: counts what line (ie. what line in RAM) the program is currently on</li>
<li>Output Register: used to display an 8-bit number to the user</li>
<li>BUS: used to transfer data around the CPU between modules</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="8bit_computer/skyline.jpg" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption>data bus on my CPU build</figcaption>
</figure>
</div>
</section>
<section id="extensions-in-my-build" class="level1">
<h1>Extensions in my build</h1>
<p>To test my understanding I wanted to build some additional functionality in my CPU that wasn’t in Ben Eater’s original. But after spending over 100 hours I wanted to do the simplest thing possible. So I implemented the capability to put the value 1 on the BUS directly without having to enter the value 1 in the machine code. This means I could write microcode to increment or decrement a value in the RAM by 1 using only one line of code. Without this change it would have taken 3 lines of code, (load RAM, subtract 1, save to RAM). I’m particularly proud of this because I haven’t seen an extension like this before, and it enables programs that weren’t possible before, for example Factorial.</p>
</section>
<section id="how-do-you-program-the-cpu" class="level1">
<h1>How do you program the CPU</h1>
<p>Using the machine code instructions below you can write a program. For the computer to run the program it needs to be manually entered into the RAM using DIP switches - these are the red toggles on the CPU. Then once the RAM is loaded start the clock and it will follow the instructions.</p>
<table class="table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Machine Code</th>
<th>Instruction</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0000</td>
<td>NOP</td>
<td>No operation</td>
</tr>
<tr class="even">
<td>0001</td>
<td>LDA X</td>
<td>Load RAM line X into Register A</td>
</tr>
<tr class="odd">
<td>0010</td>
<td>ADD X</td>
<td>Add RAM line X to Register A</td>
</tr>
<tr class="even">
<td>0011</td>
<td>SUB X</td>
<td>Subtract RAM line X from Register A</td>
</tr>
<tr class="odd">
<td>0100</td>
<td>STA X</td>
<td>Store Register A in RAM line X</td>
</tr>
<tr class="even">
<td>0101</td>
<td>LDI X</td>
<td>Load (immediate) value X into Register A</td>
</tr>
<tr class="odd">
<td>0110</td>
<td>ADI X</td>
<td>Add (immediate) value X to Register A</td>
</tr>
<tr class="even">
<td>0111</td>
<td>SUI X</td>
<td>Subtract (immediate) value X from Register A</td>
</tr>
<tr class="odd">
<td>1000</td>
<td>JMP X</td>
<td>Jump to RAM line X (change program counter to X)</td>
</tr>
<tr class="even">
<td>1001</td>
<td>JC X</td>
<td>Jump to RAM line X if carry (ie. if ALU has rolled past 255)</td>
</tr>
<tr class="odd">
<td>1010</td>
<td>JNC X</td>
<td>Jump to Ram line X if not carry</td>
</tr>
<tr class="even">
<td>1011</td>
<td>INC X</td>
<td>increment RAM line X by 1</td>
</tr>
<tr class="odd">
<td>1100</td>
<td>DEC X</td>
<td>decrement RAM line X by 1</td>
</tr>
<tr class="even">
<td>1101</td>
<td>SWP X</td>
<td>Swap Register A with RAM line X</td>
</tr>
<tr class="odd">
<td>1110</td>
<td>OUT</td>
<td>Register A to Output Register</td>
</tr>
<tr class="even">
<td>1111</td>
<td>HLT</td>
<td>Halt the program (stop the clock)</td>
</tr>
</tbody>
</table>
</section>
<section id="an-example-program" class="level1">
<h1>An example program</h1>
<section id="add-x-y" class="level2">
<h2 class="anchored" data-anchor-id="add-x-y">Add X + Y</h2>
<p>The code below is adding 42 + 13. The values 42 and 13 are part of the program and entered on lines 4 and 5. The CPU always starts at line 0 and works sequentially (unless there is a jump). Walking through the program we have:</p>
<ol start="0" type="1">
<li>Load 42 into register A</li>
<li>Add 13 to register A (42) and store answer in register A</li>
<li>output register A</li>
<li>stop the program</li>
</ol>
<table class="table">
<thead>
<tr class="header">
<th>Line</th>
<th>Instruction</th>
<th>Machine Code</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>LDA 4</td>
<td>0001 0010</td>
</tr>
<tr class="even">
<td>1</td>
<td>ADD 5</td>
<td>0010 0011</td>
</tr>
<tr class="odd">
<td>2</td>
<td>OUT</td>
<td>1110 xxxx</td>
</tr>
<tr class="even">
<td>3</td>
<td>HLT</td>
<td>1111 xxxx</td>
</tr>
<tr class="odd">
<td>4</td>
<td>42</td>
<td>0010 1010</td>
</tr>
<tr class="even">
<td>5</td>
<td>13</td>
<td>0000 1101</td>
</tr>
</tbody>
</table>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="8bit_computer/low_alu.jpg" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption>The ALU - where the addition and subtraction take place</figcaption>
</figure>
</div>
</section>
<section id="fibonacci-sequence" class="level2">
<h2 class="anchored" data-anchor-id="fibonacci-sequence">Fibonacci Sequence</h2>
<p>This is a bit of a step up from the one above. It has the conditional JC which jumps if the carry flag is set. The flag is set if the previous add (or SUB, DEC, INC) causes an overflow. So line 6 JC will only trigger when the sequence is above 255 (the largest number the CPU can handle) and will go back to the beginning of the program, otherwise it will skip and go to line 7.</p>
<table class="table">
<thead>
<tr class="header">
<th>Line</th>
<th>Instruction</th>
<th>Machine Code</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>LDI 1</td>
<td>0101 0001</td>
</tr>
<tr class="even">
<td>1</td>
<td>STA 11</td>
<td>0100 1111</td>
</tr>
<tr class="odd">
<td>2</td>
<td>STA 12</td>
<td>0100 1110</td>
</tr>
<tr class="even">
<td>3</td>
<td>OUT</td>
<td>1110 xxxx</td>
</tr>
<tr class="odd">
<td>4</td>
<td>STA 12</td>
<td>0100 1110</td>
</tr>
<tr class="even">
<td>5</td>
<td>ADD 11</td>
<td>0010 1111</td>
</tr>
<tr class="odd">
<td>6</td>
<td>JC 0</td>
<td>1001 0000</td>
</tr>
<tr class="even">
<td>7</td>
<td>SWP 12</td>
<td>1101 1110</td>
</tr>
<tr class="odd">
<td>8</td>
<td>STA 11</td>
<td>0100 1111</td>
</tr>
<tr class="even">
<td>9</td>
<td>LDA 12</td>
<td>0001 1110</td>
</tr>
<tr class="odd">
<td>10</td>
<td>JMP 3</td>
<td>1000 0011</td>
</tr>
<tr class="even">
<td>11</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>12</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Here’s the Finbonacci program in action.</p>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/jxfy_muATZQ" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/fclarke1\.github\.io\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright 2024, Fred Clarke</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>